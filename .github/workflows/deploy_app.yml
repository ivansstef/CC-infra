---
# Pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∑–±—ñ—Ä–∫–∏ —Ç–∞ –¥–µ–ø–ª–æ—é –¥–æ–¥–∞—Ç–∫—É Cinema Club

name: Deploy Application

on:
  repository_dispatch:
    types: [deploy-app]
  workflow_dispatch:  # –†—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫
    inputs:
      environment:
        description: '–°–µ—Ä–µ–¥–æ–≤–∏—â–µ –¥–ª—è –¥–µ–ø–ª–æ—é'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  push:
    branches:
      - feature/github-actions-cicd  # –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

jobs:
  build-and-deploy:
    name: Build and Deploy Cinema Club
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Cinema Club repository
        uses: actions/checkout@v4
        with:
          repository: ivansstef/CinemaClub
          ref: main
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/cinema-club:latest,${{ secrets.DOCKER_USERNAME }}/cinema-club:${{ github.sha }}
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/cinema-club
            docker-compose pull
            docker-compose up -d --force-recreate
            docker system prune -f
      
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/cinema-club
            docker-compose ps
            curl -f http://localhost:8080 || exit 1
      
      - name: Deployment successful
        run: |
          echo "‚úÖ Cinema Club deployed successfully!"
          echo "üåê Application available at: http://${{ secrets.SERVER_IP }}:8080"
          echo "üê≥ Docker image: ${{ secrets.DOCKER_USERNAME }}/cinema-club:${{ github.sha }}"
