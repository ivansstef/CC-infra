---
# Pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∑–±—ñ—Ä–∫–∏ —Ç–∞ –¥–µ–ø–ª–æ—é –¥–æ–¥–∞—Ç–∫—É Cinema Club

name: Deploy Application

on:
  # repository_dispatch:
  #   types: [deploy-app]
  workflow_dispatch:  # –†—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫
    inputs:
      environment:
        description: '–°–µ—Ä–µ–¥–æ–≤–∏—â–µ –¥–ª—è –¥–µ–ø–ª–æ—é'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  # push:
  #   branches:
  #     - feature/github-actions-cicd  # –í–∏–º–∫–Ω–µ–Ω–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ volumes + git pull

jobs:
  build-and-deploy:
    name: Build and Deploy Cinema Club
    runs-on: ubuntu-latest
    
    steps:
      - name: Set version tag
        id: version
        run: |
          VERSION="v${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è Building version: $VERSION"
      
      - name: Checkout Cinema Club repository
        uses: actions/checkout@v4
        with:
          repository: ivansstef/CinemaClub
          ref: main
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/cinemaclub:latest
            ${{ secrets.DOCKER_USERNAME }}/cinemaclub:${{ steps.version.outputs.VERSION }}
      
      - name: Set up Python for Ansible
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
      
      - name: Checkout CC-infra for Ansible playbooks
        uses: actions/checkout@v4
        with:
          path: cc-infra
      
      - name: Configure SSH for Ansible
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Create dynamic inventory
        run: |
          cd cc-infra/ansible
          cat > inventory_dynamic.ini << EOF
          [cinema]
          ${{ secrets.SERVER_IP }} ansible_user=${{ secrets.SSH_USER }} ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_port=${{ secrets.SSH_PORT || 22 }} ansible_become=yes ansible_become_method=sudo
          EOF
      
      - name: Deploy Application with Ansible
        run: |
          cd cc-infra/ansible
          ansible-playbook -i inventory_dynamic.ini deploy_application.yml --become --extra-vars "image_tag=latest"
        env:
          ANSIBLE_HOST_KEY_CHECKING: false
      
      - name: Cleanup old Docker images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Cleanup old images (keep latest + 3 last versions)
            echo "üßπ Cleaning up old Cinema Club images..."
            OLD_IMAGES=$(docker images ivansstef/cinemaclub --format "{{.Repository}}:{{.Tag}}" | grep -v "latest" | tail -n +4)
            if [ ! -z "$OLD_IMAGES" ]; then
              echo "$OLD_IMAGES" | xargs -r docker rmi || true
              echo "‚úÖ Old images removed"
            else
              echo "‚ÑπÔ∏è No old images to remove"
            fi
      
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/cinema-club
            docker-compose ps
            
            # Wait for application to start (max 60 seconds)
            for i in 1 2 3 4 5 6 7 8 9 10 11 12; do
              if curl -f http://localhost:8080 > /dev/null 2>&1; then
                echo "‚úÖ Application is responding!"
                exit 0
              fi
              echo "‚è≥ Waiting for application... (attempt $i/12)"
              sleep 5
            done
            
            echo "‚ùå Application failed to start"
            exit 1
      
      - name: Deployment successful
        run: |
          echo "‚úÖ Cinema Club deployed successfully!"
          echo "üåê Application available at: http://${{ secrets.SERVER_IP }}:8080"
          echo "üê≥ Docker images:"
          echo "   - ${{ secrets.DOCKER_USERNAME }}/cinemaclub:latest"
          echo "   - ${{ secrets.DOCKER_USERNAME }}/cinemaclub:${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "üìù Rollback command (if needed):"
          echo "   ssh deploy@server 'cd /opt/cinema-club && sed -i \"s/:latest/:${{ steps.version.outputs.VERSION }}/\" docker-compose.yml && docker-compose up -d'"
