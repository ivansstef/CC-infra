---
# Pipeline Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ Ñ–Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions

name: Deploy Infrastructure

on:
  push:
    branches:
      - main
      - feature/github-actions-cicd  # Ð”Ð»Ñ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ
    paths:
      - 'ansible/**'
      - '.github/workflows/deploy_infra.yml'
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
    inputs:
      environment:
        description: 'Ð¡ÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ðµ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾ÑŽ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-infra:
    name: Deploy Infrastructure with Ansible
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Create dynamic inventory
        run: |
          cat > ansible/inventory_dynamic.ini << EOF
          [cinema]
          ${{ secrets.SERVER_IP }} ansible_user=${{ secrets.SSH_USER }} ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_port=${{ secrets.SSH_PORT || 22 }}
          EOF
      
      - name: Test SSH connection
        run: |
          cd ansible
          ansible -i inventory_dynamic.ini cinema -m ping
      
      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory_dynamic.ini deploy.yml
      
      - name: Deployment successful
        run: |
          echo "âœ… Infrastructure deployed successfully!"
          echo "ðŸŒ Application should be available at: http://${{ secrets.SERVER_IP }}:8080"
